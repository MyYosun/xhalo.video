<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.xhalo.video.dao.VideoDao">

	<resultMap type="net.xhalo.video.model.Video" id="VideoMap">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="title" jdbcType="VARCHAR" property="title" />
		<result column="click" jdbcType="INTEGER" property="click" />
		<result column="date" jdbcType="TIMESTAMP" property="date"
			javaType="java.util.Date" />
		<result column="address" jdbcType="VARCHAR" property="address" />
		<result column="view" jdbcType="VARCHAR" property="view" />
		<result column="duration" jdbcType="INTEGER" property="duration" />
		<association property="category" javaType="net.xhalo.video.model.Category">
			<id property="id" column="category_id" />
			<result property="name" column="category_name" />
		</association>
		<association property="author" javaType="net.xhalo.video.model.User">
			<id property="id" column="author_id" />
			<result property="username" column="author_username" />
		</association>
	</resultMap>

	<resultMap type="net.xhalo.video.model.Video" id="VideoMap_detail">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="title" jdbcType="VARCHAR" property="title" />
		<result column="click" jdbcType="INTEGER" property="click" />
		<result column="date" jdbcType="TIMESTAMP" property="date"
			javaType="java.util.Date" />
		<result column="address" jdbcType="VARCHAR" property="address" />
		<result column="view" jdbcType="VARCHAR" property="view" />
		<result column="duration" jdbcType="INTEGER" property="duration" />
		<result column="info" jdbcType="VARCHAR" property="info" />
		<association property="category" javaType="net.xhalo.video.model.Category">
			<id property="id" column="category_id" />
			<result property="name" column="category_name" />
		</association>
		<association property="author" javaType="net.xhalo.video.model.User">
			<id property="id" column="author_id" />
			<result property="username" column="author_username" />
		</association>
	</resultMap>


	<select id="getVideosByCategoryAndPage" parameterType="java.util.List"
		resultMap="VideoMap">
		select
		a.id,a.title,a.click,a.date,a.address,a.view,a.duration,b.id
		category_id,b.name
		category_name,
		c.id author_id,c.username
		author_username from
		videotable a,
		categorytable b,usertable c where
		a.category=b.id and a.author=c.id and
		a.category=#{list[0]} order by a.date desc
		limit
		#{list[1]},#{list[2]}
	</select>

	<select id="getVideosByTitleAndPage" parameterType="java.util.List"
		resultMap="VideoMap">
		select
		a.id,a.title,a.click,a.date,a.address,a.view,a.duration,b.id
		category_id,b.name
		category_name,
		c.id author_id,c.username
		author_username from
		videotable a,
		categorytable b,usertable c where
		a.category=b.id and a.author=c.id and a.title
		like '%' #{list[0]} '%' order by a.date desc
		limit #{list[1],jdbcType=INTEGER},#{list[2],jdbcType=INTEGER}
	</select>

	<select id="getVideoById" parameterType="Integer" resultMap="VideoMap_detail">
		select a.id,a.title,a.click,a.date,a.address,a.view,a.duration,a.info,
		b.id category_id,b.name
		category_name,
		c.id author_id,c.username
		author_username from
		videotable a,
		categorytable b,usertable c where
		a.category=b.id and a.author=c.id and a.id=#{_parameter}
	</select>

	<delete id="deleteVideoById" parameterType="INTEGER">
		delete from
		videotable where id=#{_parameter}
	</delete>

	<insert id="addVideo" parameterType="net.xhalo.video.model.Video">
		insert into
		videotable(title,click,date,address,view,duration,info,category,author)
		values(#{title},#{click},#{date},#{address},#{view},#{duration},#{info},#{category.id},#{author.id})
	</insert>

	<select id="getVideosOrderByWhat" parameterType="String"
		resultMap="VideoMap">
		select
		a.id,
		a.title,
		a.click,
		a.date,
		a.address,
		a.view,
		a.duration,
		b.id category_id,
		b.name category_name,
		c.id author_id,
		c.username author_username
		from
		videotable a,
		categorytable b,
		usertable c
		where
		a.category=b.id
		and
		a.author=c.id
		order by ${orderItem} DESC
	</select>

	<select id="getTotalNumOfVideo" resultType="INTEGER">
		select count(id) from
		videotable;
	</select>

	<select id="getVideosByCategoryAndPageOrderByParam"
		parameterType="java.util.List" resultMap="VideoMap">
		select
		a.id,a.title,a.click,a.date,a.address,a.view,a.duration,b.id
		category_id,b.name
		category_name,
		c.id author_id,c.username
		author_username from
		videotable a,
		categorytable b,usertable c where
		a.category=b.id and a.author=c.id and
		a.category=#{list[0],jdbcType=INTEGER}
		order by ${list[1]} desc limit
		#{list[2],jdbcType=INTEGER},#{list[3],jdbcType=INTEGER}
	</select>

	<select id="getVideosOrderByClickAndLimit" parameterType="java.util.List"
		resultMap="VideoMap">
		select
		a.id,a.title,a.click,a.date,a.address,a.view,a.duration,b.id
		category_id,b.name
		category_name,
		c.id author_id,c.username
		author_username from
		videotable a,
		categorytable b,usertable c where
		a.category=b.id and a.author=c.id order by a.click desc
		limit
		#{list[0]},#{list[1]}
	</select>
	
	<update id="addClick" parameterType="net.xhalo.video.model.Video">
		update videotable set click=click+1 where id=#{id}
	</update>

</mapper>
