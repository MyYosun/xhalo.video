<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.xhalo.video.dao.UserDao">

	<resultMap type="net.xhalo.video.model.User" id="UserMap">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="username" jdbcType="VARCHAR" property="username" />
		<result column="password" jdbcType="VARCHAR" property="password" />
		<result column="nickname" jdbcType="VARCHAR" property="nickname" />
		<result column="enabled" jdbcType="BIGINT" javaType="boolean" property="enabled" />
		<result column="authority" jdbcType="VARCHAR" property="authority" />
		<result column="sign" jdbcType="VARCHAR" property="sign" />
		<result column="head_img" jdbcType="VARCHAR" property="headImg" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
		<result column="last_login_time" jdbcType="TIMESTAMP" property="lastLoginTime" />
	</resultMap>

	<insert id="addUser" parameterType="net.xhalo.video.model.User">
		INSERT INTO usertable(
		username,
		password,
		nickname,
		enabled,
		authority,
		sign,
		head_img,
		create_time
		) VALUES (
		#{username},
		#{password},
		#{nickname},
		#{enable},
		#{authority},
		#{sign},
		#{headImg},
		CURRENT_TIMESTAMP
		)
	</insert>

	<select id="validateUser" parameterType="net.xhalo.video.model.User" resultMap="UserMap">
		SELECT
		id,
		username,
		password,
		nickname,
		enabled,
		authority,
		sign,
		head_img,
		create_time,
		last_login_time
		FROM
		usertable
		WHERE
		username=#{username}
		AND
		password=#{password}
		AND
		enabled = TRUE
	</select>

	<select id="validateUsername" parameterType="net.xhalo.video.model.User"
		resultType="INTEGER">
		SELECT
		COUNT(id)
		FROM
		usertable
		WHERE
		username=#{username}
		AND
		enabled = TRUE
	</select>

	<update id="updateLoginTime" parameterType="net.xhalo.video.model.User">
		UPDATE
		usertable
		SET
		last_login_time = CURRENT_TIMESTAMP
		WHERE
		username = #{username}
	</update>

	<select id="findByUsername" parameterType="String" resultMap="UserMap">
		SELECT
		username,
		password,
		authority
		FROM
		usertable
		WHERE
		username=#{username}
		AND
		enabled = TRUE
	</select>

</mapper>
